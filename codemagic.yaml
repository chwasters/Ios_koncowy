# Plik konfiguracyjny Codemagic dla aplikacji iOS "bartek" - Wynajem Samochodów
# Autor: Jakub Nowosad
# Data: 13.06.2025

workflows:
  # Workflow deweloperski - uproszczony build bez podpisywania (idealny dla studentów)
  ios-development:
    name: iOS Development Build
    instance_type: mac_mini_m1
    max_build_duration: 60
    environment:
      vars:
        XCODE_PROJECT: "bartek.xcodeproj"
        XCODE_SCHEME: "bartek"
        BUNDLE_ID: "com.jacooo13.bartek"
      xcode: 15.2
    scripts:
      - name: Set up keychain for code signing (optional, if needed)
        script: |
          # Keychains are not persisted for free tier, set up fresh each time if manual signing is used.
          # For automatic signing or builds without distribution, this might not be needed.
          echo "Skipping keychain setup for basic build"
      
      - name: Build project for iOS Simulator
        script: |
          set -eo pipefail # Exit on error

          xcodebuild build \
            -project "$CM_BUILD_DIR/$XCODE_PROJECT" \
            -scheme "$XCODE_SCHEME" \
            -sdk iphonesimulator \
            -configuration Debug \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            PRODUCT_BUNDLE_IDENTIFIER="$BUNDLE_ID"
      
      - name: Build project for iOS Device (without signing)
        script: |
          set -eo pipefail # Exit on error

          xcodebuild build \
            -project "$CM_BUILD_DIR/$XCODE_PROJECT" \
            -scheme "$XCODE_SCHEME" \
            -sdk iphoneos \
            -configuration Release \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            PRODUCT_BUNDLE_IDENTIFIER="$BUNDLE_ID"
    
    artifacts:
      - $HOME/Library/Developer/Xcode/DerivedData/**/Build/Products/Debug-iphonesimulator/*.app
      - $HOME/Library/Developer/Xcode/DerivedData/**/Build/Products/Release-iphoneos/*.app
      - /tmp/xcodebuild_logs/*.log
    
    publishing:
      email:
        recipients:
          - jakub.nowosad@student.example.com  # Zmień na swój email
        notify:
          success: true
          failure: true

  # Workflow testowy - uruchamianie testów jednostkowych
  ios-testing:
    name: iOS Unit Tests
    instance_type: mac_mini_m1
    max_build_duration: 30
    environment:
      vars:
        XCODE_PROJECT: "bartek.xcodeproj"
        XCODE_SCHEME: "bartek"
      xcode: 15.2
    scripts:
      - name: Run unit tests
        script: |
          set -eo pipefail # Exit on error
          
          xcodebuild test \
            -project "$CM_BUILD_DIR/$XCODE_PROJECT" \
            -scheme "$XCODE_SCHEME" \
            -sdk iphonesimulator \
            -destination 'platform=iOS Simulator,name=iPhone 15,OS=latest' \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO
    
    artifacts:
      - /tmp/xcodebuild_logs/*.log
    
    publishing:
      email:
        recipients:
          - jakub.nowosad@student.example.com
        notify:
          success: false  # Nie wysyłaj emaila przy sukcesie testów
          failure: true   # Tylko przy niepowodzeniu
